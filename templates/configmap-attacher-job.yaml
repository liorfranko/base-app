{{- $configmapList := printf "%s" (include "configmapList" .) -}}
{{- $timeNow := (now | date "20060102150405") }}
{{- $appname := printf "%s" (include "name" .) -}}
{{- $kubeTargetVersion := default .Capabilities.KubeVersion.GitVersion .Values.kubeTargetVersionOverride }}
apiVersion: batch/v1
kind: Job
metadata:
  namespace: kube-system
  labels:
    app: "{{ $appname }}"
  name: configmap-attacher-job-{{ $appname }}-{{ $timeNow }}
spec:
  backoffLimit: 3
  template:
    metadata:
      name: "{{ $appname }}"
      annotations:
      labels:
        app: "{{ $appname }}"
    spec:
      containers:
      - name: {{ $appname }}-configmap-attacher-job
        args: ["-rollout", "{{ $appname }}", "-namespace", "{{ .Release.Namespace }}", "-configmaps", "{{ $configmapList }}"]
        image: {{ .Values.configmapAttacher.repository }}:{{ .Values.configmapAttacher.tag }}
        resources:
          requests: {{ toYaml .Values.configmapAttacher.resources.requests | nindent 12 }}
          limits: {{ toYaml .Values.configmapAttacher.resources.limits | nindent 12 }}
        env:
          - name: VERSION
            value: "{{ .Values.configmapAttacher.tag | toString }}"
          - name: LOG_LEVEL
            value: "debug"
          - name: JOB_NAME
            value: "configmap-attacher-job-{{ $appname }}-{{ $timeNow }}"
      restartPolicy: OnFailure
      serviceAccountName: configmap-attacher-job
      {{- if and (semverCompare ">=1.21.0-0" $kubeTargetVersion) (semverCompare "<9.9.9-9" $kubeTargetVersion)
      ttlSecondsAfterFinished: 100
      {{-end }}
